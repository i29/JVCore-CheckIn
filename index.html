<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Checkin</title>
    <script src="./web3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: #000000;
            min-height: 100vh;
        }

        body {
            font-family: 'Rajdhani', 'Orbitron', 'Courier New', monospace;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #1a0033 50%, #000000 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(0, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 0, 255, 0.06) 0%, transparent 50%);
            background-size: 80px 80px, 120px 120px;
            animation: gridMove 40s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 255, 0.04) 2px,
                    rgba(0, 255, 255, 0.04) 4px
                );
            pointer-events: none;
            z-index: 1;
            animation: scanlines 8s linear infinite;
        }

        @keyframes gridMove {
            0% {
                background-position: 0 0, 0 0;
            }
            100% {
                background-position: 40px 40px, -40px -40px;
            }
        }
        
        @keyframes scanlines {
            0% { transform: translateY(-100%); opacity: 1; }
            50% { opacity: 0.8; }
            100% { transform: translateY(100vh); opacity: 0.3; }
        }

        .container {
            background: rgba(0, 20, 40, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 
                0 0 50px rgba(0, 255, 255, 0.3),
                inset 0 0 50px rgba(0, 255, 255, 0.1),
                0 0 100px rgba(255, 0, 255, 0.2);
            border: 2px solid;
            border-image: linear-gradient(45deg, #00ffff, #ff00ff, #00ff00, #ffff00) 1;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            z-index: 2;
            overflow: hidden;
        }

        /* .container::after {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: scanline 2s linear infinite;
            z-index: 1;
        } */
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 3px,
                    rgba(0, 255, 255, 0.015) 3px,
                    rgba(0, 255, 255, 0.015) 6px
                );
            pointer-events: none;
            z-index: 0;
        }

        @keyframes containerGlow {
            0% {
                box-shadow: 
                    0 0 30px rgba(0, 255, 255, 0.3),
                    inset 0 0 30px rgba(0, 255, 255, 0.1),
                    0 0 60px rgba(255, 0, 255, 0.2);
            }
            100% {
                box-shadow: 
                    0 0 60px rgba(0, 255, 255, 0.5),
                    inset 0 0 60px rgba(0, 255, 255, 0.2),
                    0 0 120px rgba(255, 0, 255, 0.4);
            }
        }

        @keyframes scanline {
            0% {
                top: -2px;
            }
            100% {
                top: 100%;
            }
        }

        @keyframes glitch {
            0%, 100% {
                transform: translateX(-50%) translate(0);
            }
            20% {
                transform: translateX(-50%) translate(-2px, 2px);
            }
            40% {
                transform: translateX(-50%) translate(-2px, -2px);
            }
            60% {
                transform: translateX(-50%) translate(2px, 2px);
            }
            80% {
                transform: translateX(-50%) translate(2px, -2px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes containerPattern {
            0% {
                background-position: 0 0, 0 0;
            }
            100% {
                background-position: 20px 20px, -20px -20px;
            }
        }
        
        @keyframes dataStream {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100vw);
                opacity: 0;
            }
        }

        @keyframes dataFlicker {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 5px currentColor;
            }
            25% {
                opacity: 0.8;
                text-shadow: 0 0 10px currentColor;
            }
            50% {
                opacity: 0.9;
                text-shadow: 0 0 15px currentColor;
            }
            75% {
                opacity: 0.7;
                text-shadow: 0 0 8px currentColor;
            }
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: loading 1s linear infinite;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo-image {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px #00ffff) drop-shadow(0 0 20px #00ffff);
            animation: logoImageGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes logoImageGlow {
            0% {
                filter: drop-shadow(0 0 10px #00ffff) drop-shadow(0 0 20px #00ffff);
            }
            100% {
                filter: drop-shadow(0 0 15px #00ffff) drop-shadow(0 0 30px #00ffff) drop-shadow(0 0 40px #00ffff);
            }
        }

        .logo {
            font-size: 3.5rem;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 0;
            text-shadow: 
                0 0 10px #00ffff,
                0 0 20px #00ffff,
                0 0 30px #00ffff,
                0 0 40px #00ffff;
            animation: logoGlow 2s ease-in-out infinite alternate;
            font-family: 'Orbitron', monospace;
            letter-spacing: 4px;
            text-transform: uppercase;
            position: relative;
        }
        
        .logo::before {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            color: #ff0080;
            opacity: 0.3;
            z-index: -1;
        }

        @keyframes logoGlow {
            0% {
                text-shadow: 
                    0 0 10px #00ffff,
                    0 0 20px #00ffff,
                    0 0 30px #00ffff,
                    0 0 40px #00ffff;
            }
            100% {
                text-shadow: 
                    0 0 20px #00ffff,
                    0 0 30px #00ffff,
                    0 0 40px #00ffff,
                    0 0 50px #00ffff,
                    0 0 60px #00ffff;
            }
        }

        .subtitle {
            color: #00ff88;
            margin-bottom: 30px;
            font-size: 1.4rem;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
            font-family: 'Exo 2', sans-serif;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .wallet-section {
            margin-bottom: 30px;
        }

        .wallet-address {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid #00ffff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #00ffff;
            font-family: 'Exo 2', monospace;
            font-weight: 500;
            letter-spacing: 1px;
            word-break: break-all;
            display: none;
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.3),
                inset 0 0 15px rgba(0, 255, 255, 0.1);
            text-shadow: 0 0 5px #00ffff;
        }

        .btn {
            background: linear-gradient(45deg, #001122, #003344);
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 14px 28px;
            color: #00ffff;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.3),
                inset 0 0 20px rgba(0, 255, 255, 0.1);
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 2px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            text-shadow: 0 0 5px #00ffff;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-connect {
            border-color: #00ff00;
            color: #00ff00;
            box-shadow: 
                0 0 20px rgba(0, 255, 0, 0.3),
                inset 0 0 20px rgba(0, 255, 0, 0.1);
        }

        .btn-connect:hover {
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            text-shadow: 0 0 5px #00ff00;
        }

        .btn-connect::before {
            background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.4), transparent);
        }

        .btn-disconnect {
            border-color: rgba(255, 0, 64, 0.5);
            color: rgba(255, 0, 64, 0.7);
            box-shadow: 
                0 0 10px rgba(255, 0, 64, 0.2),
                inset 0 0 10px rgba(255, 0, 64, 0.05);
            display: none;
            font-size: 0.9rem;
            padding: 10px 20px;
            opacity: 0.8;
            transform: scale(0.9);
        }

        .btn-disconnect:hover {
            box-shadow: 0 0 15px rgba(255, 0, 64, 0.3);
            text-shadow: 0 0 3px rgba(255, 0, 64, 0.5);
            opacity: 1;
            transform: scale(0.9) translateY(-1px);
        }

        .btn-disconnect::before {
            background: linear-gradient(90deg, transparent, rgba(255, 0, 64, 0.2), transparent);
        }

        .btn-checkin {
            border-color: #ffff00;
            color: #ffff00;
            font-size: 1.3rem;
            padding: 20px 40px;
            display: none;
            margin: 20px auto;
            box-shadow: 
                0 0 20px rgba(255, 255, 0, 0.3),
                inset 0 0 20px rgba(255, 255, 0, 0.1);
        }

        .btn-checkin:hover {
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
            text-shadow: 0 0 5px #ffff00;
        }

        .btn-checkin::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 0, 0.4), transparent);
        }



        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        #statusMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90vw;
            width: auto;
            min-width: 300px;
            margin: 0;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: center;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 15px 20px;
        }

        .status.success {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid #00ff00;
            box-shadow: 
                0 0 15px rgba(0, 255, 0, 0.3),
                inset 0 0 15px rgba(0, 255, 0, 0.1);
            text-shadow: 0 0 10px #00ff00;
        }

        .status.error {
            background: rgba(255, 0, 64, 0.1);
            color: #ff0040;
            border: 1px solid #ff0040;
            box-shadow: 
                0 0 15px rgba(255, 0, 64, 0.3),
                inset 0 0 15px rgba(255, 0, 64, 0.1);
            text-shadow: 0 0 10px #ff0040;
        }

        .status.info {
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            border: 1px solid #00ffff;
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.3),
                inset 0 0 15px rgba(0, 255, 255, 0.1);
            text-shadow: 0 0 10px #00ffff;
        }

        .member-info {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid #ff00ff;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            color: #ff00ff;
            display: none;
            box-shadow: 
                0 0 15px rgba(255, 0, 255, 0.3),
                inset 0 0 15px rgba(255, 0, 255, 0.1);
            text-shadow: 0 0 5px #ff00ff;
            font-family: 'Rajdhani', sans-serif;
            /* animation: dataFlicker 3s ease-in-out infinite; */
        }
        
        .member-info h3 {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .member-info p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .wallet-address {
            /* animation: dataFlicker 4s ease-in-out infinite; */
        }

        .status {
            /* animation: dataFlicker 2s ease-in-out infinite; */
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #00ffff;
            border-radius: 50%;
            animation: float 8s infinite linear;
            box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        }
        
        .particle:nth-child(2n) {
            background: #ff0080;
            animation-duration: 12s;
            width: 2px;
            height: 2px;
        }
        
        .particle:nth-child(3n) {
            background: #00ff88;
            animation-duration: 10s;
            width: 4px;
            height: 4px;
        }
        
        .particle:nth-child(4n) {
            background: #ffff00;
            animation-duration: 15s;
            width: 1px;
            height: 1px;
        }
        
        .particle:nth-child(5n) {
            background: #ffffff;
            animation-duration: 6s;
            width: 2px;
            height: 2px;
            box-shadow: 0 0 5px currentColor;
        }
        
        .data-streams {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .data-stream {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, #ff0080, transparent);
            animation: dataStream 8s linear infinite;
            opacity: 0.6;
        }
        
        .data-stream:nth-child(2n) {
            background: linear-gradient(90deg, transparent, #00ff88, #ffff00, transparent);
            animation-duration: 12s;
        }
        
        .data-stream:nth-child(3n) {
            background: linear-gradient(90deg, transparent, #ff0080, #00ffff, transparent);
            animation-duration: 10s;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="data-streams" id="dataStreams"></div>
    
    <div class="container">
        <div class="logo-container">
            <img src="./jv.svg" alt="JV Logo" class="logo-image" />
            <div class="logo" data-text="JVCore">JVCore</div>
        </div>
        <div class="subtitle">åŒºå—é“¾ç­¾åˆ°ç³»ç»Ÿ</div>
        

        
        <div class="wallet-section">
            <button class="btn btn-connect" id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
            <button class="btn btn-disconnect" id="disconnectBtn" onclick="disconnectWallet()">æ–­å¼€è¿æ¥</button>
            <div class="wallet-address" id="walletAddress"></div>
        </div>
        
        <div class="member-info" id="memberInfo">
            <div>æˆå‘˜çŠ¶æ€: <span id="memberStatus">æ£€æŸ¥ä¸­...</span></div>
            <!-- <div>æŒæœ‰æ•°é‡: <span id="memberCount">0</span></div> -->
            <div id="memberNumbers" style="display: none; margin-top: 10px;">
                <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">æˆå‘˜ç¼–å·: <span id="memberNumbersList"></span></div>
            </div>
            <div id="lastCheckInInfo" style="display: none; margin-top: 10px;">
                <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">æœ€åç­¾åˆ°: <span id="lastCheckInTime">æœªç­¾åˆ°</span></div>
                <div id="checkInStatus" style="color: #00ff88; font-size: 0.8rem; margin-top: 5px;"></div>
            </div>
            <div id="nonMemberTip" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid #ffc107;">
                <div style="color: #ffc107; font-size: 0.9rem;">ğŸ’¡ æ‚¨è¿˜ä¸æ˜¯æˆå‘˜</div>
                <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.8rem; margin-top: 5px;">æˆä¸ºæˆå‘˜åå¯äº«å—æ›´å¤šæƒç›Šå’ŒåŠŸèƒ½</div>
            </div>

        </div>
        
        <button class="btn btn-checkin hidden" id="checkinBtn" onclick="CheckInManager.performCheckIn()">ğŸ¯ ç«‹å³ç­¾åˆ°</button>
    </div>
    
    <div class="status hidden" id="statusMessage"></div>

    <script>
        // Web3.js å·²é€šè¿‡ script æ ‡ç­¾ç›´æ¥å¼•ç”¨ï¼Œæ— éœ€åŠ¨æ€åŠ è½½
        
        // å…¨å±€å‡½æ•°å®šä¹‰ - éœ€è¦åœ¨HTML onclickä¸­ä½¿ç”¨
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            
            // æ£€æŸ¥Web3æ˜¯å¦å·²åŠ è½½
            if (typeof Web3 === 'undefined') {
                UIManager.showStatus('Web3æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•...', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å®‰è£…äº†MetaMask
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // æ·»åŠ åŠ è½½çŠ¶æ€
                    connectBtn.classList.add('loading');
                    connectBtn.textContent = 'è¿æ¥ä¸­...';
                    connectBtn.disabled = true;
                    
                    UIManager.showStatus('æ­£åœ¨è¿æ¥é’±åŒ…...', 'info');
                    
                    // è¯·æ±‚ç”¨æˆ·æˆæƒè®¿é—®è´¦æˆ·
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    
                    // ä¿å­˜ç”¨æˆ·è´¦æˆ·å’ŒWeb3å®ä¾‹
                    AppState.userAccount = accounts[0];
                    AppState.web3 = new Web3(window.ethereum);
                    
                    // æ£€æŸ¥å¹¶åˆ‡æ¢åˆ°æ­£ç¡®çš„åŒºå—é“¾ç½‘ç»œ
                    await NetworkManager.switchToCorrectNetwork();
                    
                    // åˆå§‹åŒ–æ™ºèƒ½åˆçº¦å®ä¾‹
                    ContractManager.initialize();
                    
                    // æ›´æ–°ç”¨æˆ·ç•Œé¢
                    UIManager.updateWalletUI(true);
                    
                    UIManager.showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                    
                    // æ£€æŸ¥ç”¨æˆ·æˆå‘˜çŠ¶æ€
                    await MemberManager.checkMembership();
                    
                } catch (error) {
                    console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                    UIManager.showStatus('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    connectBtn.classList.remove('loading');
                    connectBtn.textContent = 'è¿æ¥é’±åŒ…';
                    connectBtn.disabled = false;
                }
            } else {
                UIManager.showStatus('è¯·å®‰è£… MetaMask é’±åŒ…ï¼', 'error');
            }
        }
        
        function disconnectWallet() {
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            // æ·»åŠ æ–­å¼€è¿æ¥åŠ¨ç”»æ•ˆæœ
            disconnectBtn.style.animation = 'pulse 0.3s ease-in-out';
            
            AppState.reset();                    // é‡ç½®åº”ç”¨çŠ¶æ€
            UIManager.updateWalletUI(false);    // æ›´æ–°UIä¸ºæœªè¿æ¥çŠ¶æ€
            UIManager.showStatus('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
            
            // é‡ç½®æŒ‰é’®åŠ¨ç”»
            setTimeout(() => {
                disconnectBtn.style.animation = '';
            }, 300);
        }
        
        // ä¸»åº”ç”¨åˆå§‹åŒ–å‡½æ•°
        // JVCore åˆçº¦ ABI (åŒ…å«ç­¾åˆ°å’ŒNFTåŠŸèƒ½)
        const JVCORE_ABI = [
            // ç­¾åˆ°ç›¸å…³åŠŸèƒ½
            {
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "checkIn",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
    {
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "blockNumber",
				"type": "uint256"
			}
		],
		"name": "CheckIn",
		"type": "event"
	},

            // NFTç›¸å…³åŠŸèƒ½
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "index",
                        "type": "uint256"
                    }
                ],
                "name": "tokenOfOwnerByIndex",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "tokenURI",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ownerOf",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

    /**
     * åº”ç”¨çŠ¶æ€ç®¡ç†å™¨
     * ç»Ÿä¸€ç®¡ç†Web3å®ä¾‹ã€ç”¨æˆ·è´¦æˆ·å’Œæ™ºèƒ½åˆçº¦å®ä¾‹
     */
    const AppState = {
            web3: null,              // Web3å®ä¾‹
            userAccount: null,       // å½“å‰è¿æ¥çš„ç”¨æˆ·è´¦æˆ·åœ°å€
            contracts: {
                jvcore: null         // JVCoreåˆçº¦å®ä¾‹ï¼ˆåŒ…å«ç­¾åˆ°å’ŒNFTåŠŸèƒ½ï¼‰
            },
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            reset() {
                this.web3 = null;
                this.userAccount = null;
                this.contracts.jvcore = null;
            },
            
            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
            isConnected() {
                return this.web3 && this.userAccount;
            },
            
            // æ£€æŸ¥åˆçº¦æ˜¯å¦å·²åˆå§‹åŒ–
            areContractsReady() {
                return this.contracts.jvcore;
            }
        };
        
    /**
     * é…ç½®ç®¡ç†å™¨
     * é›†ä¸­ç®¡ç†åˆçº¦åœ°å€å’Œç½‘ç»œé…ç½®
     */
    const CONFIG = {
            contracts: {
                jvcore: '0x8d214415b9c5F5E4Cf4CbCfb4a5DEd47fb516392'    // JVCoreåˆçº¦åœ°å€ï¼ˆåŒ…å«ç­¾åˆ°å’ŒNFTåŠŸèƒ½ï¼‰
            },
            network: {
                chainId: '0xe52',                                        // JNS DAOç½‘ç»œé“¾ID (3666)
                chainName: 'JNS DAO Network',
                nativeCurrency: {
                    name: 'J',
                    symbol: 'J',
                    decimals: 18
                },
                rpcUrls: ['https://rpc.jnsdao.com:8503'],
                blockExplorerUrls: ['https://jscan.jnsdao.com']
            }
        };
        
    /**
     * å·¥å…·å‡½æ•°é›†åˆ
     * æä¾›é€šç”¨çš„è¾…åŠ©åŠŸèƒ½
     */
    const Utils = {
            /**
             * éªŒè¯ä»¥å¤ªåŠåœ°å€æ ¼å¼
             * @param {string} address - å¾…éªŒè¯çš„åœ°å€
             * @returns {boolean} æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€
             */
            isValidEthereumAddress(address) {
                if (!address || address === '') return false;
                return /^0x[a-fA-F0-9]{40}$/.test(address);
            },
            
            /**
             * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå¯è¯»æ ¼å¼
             * @param {number} timestamp - Unixæ—¶é—´æˆ³
             * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
             */
            formatTimestamp(timestamp) {
                if (!timestamp || timestamp === 0) return 'æœªç­¾åˆ°';
                const date = new Date(timestamp * 1000);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },
            
            /**
             * æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦ä¸ºå½“å‰æœˆä»½
             * @param {number} timestamp - Unixæ—¶é—´æˆ³
             * @returns {boolean} æ˜¯å¦ä¸ºå½“å‰æœˆä»½
             */
            isCurrentMonth(timestamp) {
                if (!timestamp || timestamp === 0) return false;
                const checkInDate = new Date(timestamp * 1000);
                const now = new Date();
                return checkInDate.getFullYear() === now.getFullYear() && 
                       checkInDate.getMonth() === now.getMonth();
            },
            
            /**
             * è§£æTokenå…ƒæ•°æ®
             * æ”¯æŒBase64ç¼–ç çš„JSONã€ç›´æ¥JSONå’ŒHTTP URLæ ¼å¼
             * @param {string} tokenURI - Tokençš„URI
             * @returns {Object|null} è§£æåçš„å…ƒæ•°æ®å¯¹è±¡ï¼Œå¤±è´¥æ—¶è¿”å›null
             */
            parseTokenMetadata(tokenURI) {
                try {
                    if (!tokenURI) return null;
                    
                    // å¤„ç†Base64ç¼–ç çš„JSON (data:application/json;base64,xxx)
                    if (tokenURI.startsWith('data:application/json;base64,')) {
                        const base64Data = tokenURI.split(',')[1];
                        const jsonString = atob(base64Data);
                        return JSON.parse(jsonString);
                    }
                    
                    // å¤„ç†ç›´æ¥çš„JSONå­—ç¬¦ä¸²
                    if (tokenURI.startsWith('{')) {
                        return JSON.parse(tokenURI);
                    }
                    
                    // å¤„ç†HTTP URL (éœ€è¦é€šè¿‡ä»£ç†æˆ–CORSå¤„ç†)
                    if (tokenURI.startsWith('http')) {
                        console.warn('HTTP URLéœ€è¦å¼‚æ­¥å¤„ç†:', tokenURI);
                        return { name: 'Loading...', description: 'Fetching metadata...' };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('è§£æTokenå…ƒæ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
        };
        
    /**
     * æ™ºèƒ½åˆçº¦ç®¡ç†å™¨
     * è´Ÿè´£åˆå§‹åŒ–å’Œç®¡ç†æ‰€æœ‰æ™ºèƒ½åˆçº¦å®ä¾‹
     */
    const ContractManager = {
            /**
             * åˆå§‹åŒ–æ‰€æœ‰åˆçº¦å®ä¾‹
             * @throws {Error} å½“åˆçº¦åˆå§‹åŒ–å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
             */
            initialize() {
                try {
                    this.initializeJVCoreContract();
                    console.log('åˆçº¦åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('åˆçº¦åˆå§‹åŒ–å¤±è´¥:', error);
                    throw error;
                }
            },
            
            /**
             * åˆå§‹åŒ–JVCoreåˆçº¦ï¼ˆåŒ…å«ç­¾åˆ°å’ŒNFTåŠŸèƒ½ï¼‰
             * @throws {Error} å½“åˆçº¦åœ°å€æ— æ•ˆæ—¶æŠ›å‡ºé”™è¯¯
             */
            initializeJVCoreContract() {
                if (!Utils.isValidEthereumAddress(CONFIG.contracts.jvcore)) {
                    throw new Error('JVCoreåˆçº¦åœ°å€æ— æ•ˆ');
                }
                AppState.contracts.jvcore = new AppState.web3.eth.Contract(JVCORE_ABI, CONFIG.contracts.jvcore);
            }
        };
        
    // åˆå§‹åŒ–ç²’å­æ•ˆæœï¼ˆä¼˜åŒ–ç‰ˆæœ¬ - å‡å°‘ç²’å­æ•°é‡ï¼‰
    function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
    function createDataStreams() {
            const dataStreamsContainer = document.getElementById('dataStreams');
            for (let i = 0; i < 4; i++) {
                const stream = document.createElement('div');
                stream.className = 'data-stream';
                stream.style.left = Math.random() * 100 + '%';
                stream.style.animationDelay = Math.random() * 6 + 's';
                stream.style.animationDuration = (Math.random() * 3 + 5) + 's';
                
                // ç®€åŒ–æ¸å˜é¢œè‰²é€‰æ‹©
                const gradients = [
                    'linear-gradient(180deg, transparent, #00ffff, transparent)',
                    'linear-gradient(180deg, transparent, #ff00ff, transparent)'
                ];
                stream.style.background = gradients[Math.floor(Math.random() * gradients.length)];
                
                dataStreamsContainer.appendChild(stream);
            }
        }
        
    /**
     * ç”¨æˆ·ç•Œé¢ç®¡ç†å™¨
     * è´Ÿè´£æ‰€æœ‰UIå…ƒç´ çš„æ›´æ–°å’ŒçŠ¶æ€ç®¡ç†
     */
    const UIManager = {
            /**
             * æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
             * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯å†…å®¹
             * @param {string} type - æ¶ˆæ¯ç±»å‹ ('info'|'success'|'error')
             */
            showStatus(message, type = 'info') {
                const statusEl = document.getElementById('statusMessage');
                
                // é‡ç½®æ‰€æœ‰æ ·å¼ç¡®ä¿æ­£ç¡®å±…ä¸­
                statusEl.style.opacity = '0';
                statusEl.style.transform = 'translateX(-50%) translateY(-10px)';
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                statusEl.classList.remove('hidden');
                
                // è§¦å‘æ·¡å…¥åŠ¨ç”»
                requestAnimationFrame(() => {
                    statusEl.style.transition = 'all 0.3s ease-out';
                    statusEl.style.opacity = '1';
                    statusEl.style.transform = 'translateX(-50%) translateY(0)';
                });
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ·»åŠ ç‰¹æ®Šæ•ˆæœ
                if (type === 'success') {
                    statusEl.style.animation = 'pulse 0.6s ease-in-out';
                } else if (type === 'error') {
                    statusEl.style.animation = 'glitch 0.5s ease-in-out';
                }
                
                // æ ¹æ®å†…å®¹é•¿åº¦è°ƒæ•´æ˜¾ç¤ºæ—¶é—´
                const displayTime = Math.max(3000, Math.min(8000, message.length * 100));
                
                // è‡ªåŠ¨éšè—æ¶ˆæ¯
                setTimeout(() => {
                    statusEl.style.transition = 'all 0.3s ease-in';
                    statusEl.style.opacity = '0';
                    statusEl.style.transform = 'translateX(-50%) translateY(-10px)';
                    
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                        statusEl.style.animation = '';
                    }, 300);
                }, displayTime);
            },
            
            /**
             * æ›´æ–°é’±åŒ…è¿æ¥çŠ¶æ€çš„UIæ˜¾ç¤º
             * @param {boolean} connected - æ˜¯å¦å·²è¿æ¥é’±åŒ…
             */
            updateWalletUI(connected) {
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                const walletAddress = document.getElementById('walletAddress');
                const memberInfo = document.getElementById('memberInfo');
                const checkinBtn = document.getElementById('checkinBtn');
                
                if (connected) {
                    // æ˜¾ç¤ºå·²è¿æ¥çŠ¶æ€çš„UIå…ƒç´ 
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    walletAddress.style.display = 'block';
                    walletAddress.textContent = `é’±åŒ…åœ°å€: ${AppState.userAccount}`;
                    memberInfo.style.display = 'block';
                    checkinBtn.style.display = 'inline-block';
                } else {
                    // æ˜¾ç¤ºæœªè¿æ¥çŠ¶æ€çš„UIå…ƒç´ 
                    connectBtn.style.display = 'inline-block';
                    disconnectBtn.style.display = 'none';
                    walletAddress.style.display = 'none';
                    memberInfo.style.display = 'none';
                    checkinBtn.style.display = 'none';
                    this.clearMemberInfo();
                }
            },
            
            /**
             * æ¸…é™¤æˆå‘˜ä¿¡æ¯æ˜¾ç¤º
             */
            clearMemberInfo() {
                document.getElementById('memberStatus').textContent = 'æ£€æŸ¥ä¸­...';
                document.getElementById('memberNumbers').style.display = 'none';
                document.getElementById('lastCheckInInfo').style.display = 'none';
            },
            
            /**
             * æ›´æ–°æˆå‘˜çŠ¶æ€æ˜¾ç¤º
             * @param {boolean} isMember - æ˜¯å¦ä¸ºæˆå‘˜
             * @param {number} memberCount - æˆå‘˜NFTæ•°é‡
             */
            updateMemberStatus(isMember, memberCount = 0) {
                const statusEl = document.getElementById('memberStatus');
                const checkinBtn = document.getElementById('checkinBtn');
                const nonMemberTip = document.getElementById('nonMemberTip');
                
                if (isMember) {
                    // æ˜¾ç¤ºæˆå‘˜çŠ¶æ€
                    statusEl.textContent = 'âœ…';
                    statusEl.style.color = '#00ff88';
                    statusEl.style.fontWeight = 'bold';
                    statusEl.style.textShadow = '0 0 10px rgba(0, 255, 136, 0.5)';
                    // ç¡®ä¿ç­¾åˆ°æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
                    checkinBtn.style.display = 'block';
                    checkinBtn.classList.remove('hidden');
                    if (nonMemberTip) nonMemberTip.style.display = 'none';
                } else {
                    // æ˜¾ç¤ºéæˆå‘˜çŠ¶æ€
                    statusEl.textContent = 'âŒ éæˆå‘˜';
                    statusEl.style.color = '#f44336';
                    checkinBtn.style.display = 'none';
                    document.getElementById('memberNumbers').style.display = 'none';
                    if (nonMemberTip) nonMemberTip.style.display = 'block';
                }
            }
        };
        
    /**
     * ç½‘ç»œç®¡ç†å™¨
     * å¤„ç†åŒºå—é“¾ç½‘ç»œç›¸å…³æ“ä½œ
     */
    const NetworkManager = {
            /**
             * åˆ‡æ¢åˆ°æ­£ç¡®çš„åŒºå—é“¾ç½‘ç»œ
             * å¦‚æœç½‘ç»œä¸å­˜åœ¨åˆ™è‡ªåŠ¨æ·»åŠ 
             * @throws {Error} å½“ç½‘ç»œåˆ‡æ¢æˆ–æ·»åŠ å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
             */
            async switchToCorrectNetwork() {
                try {
                    // å°è¯•åˆ‡æ¢åˆ°ç›®æ ‡ç½‘ç»œ
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CONFIG.network.chainId }]
                    });
                    UIManager.showStatus('å·²åˆ‡æ¢åˆ° JNS DAO ç½‘ç»œ', 'success');
                } catch (switchError) {
                    // å¦‚æœç½‘ç»œä¸å­˜åœ¨(é”™è¯¯ç 4902)ï¼Œåˆ™æ·»åŠ ç½‘ç»œ
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [CONFIG.network]
                            });
                            UIManager.showStatus('JNS DAO ç½‘ç»œæ·»åŠ æˆåŠŸï¼', 'success');
                        } catch (addError) {
                            console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', addError);
                            UIManager.showStatus('æ·»åŠ ç½‘ç»œå¤±è´¥: ' + addError.message, 'error');
                            throw addError;
                        }
                    } else {
                        console.error('åˆ‡æ¢ç½‘ç»œå¤±è´¥:', switchError);
                        UIManager.showStatus('åˆ‡æ¢ç½‘ç»œå¤±è´¥: ' + switchError.message, 'error');
                        throw switchError;
                    }
                }
            }
        };

        // è§£æTokenå…ƒæ•°æ®


        
    /**
     * æˆå‘˜ç®¡ç†å™¨
     * å¤„ç†æˆå‘˜èµ„æ ¼éªŒè¯å’Œæˆå‘˜ä¿¡æ¯æ˜¾ç¤º
     */
    const MemberManager = {
            /**
             * æ£€æŸ¥ç”¨æˆ·çš„æˆå‘˜èµ„æ ¼
             * éªŒè¯ç”¨æˆ·æ˜¯å¦æŒæœ‰æˆå‘˜NFT
             */
            async checkMembership() {
                if (!AppState.userAccount) {
                    UIManager.updateMemberStatus(false);
                    document.getElementById('memberStatus').textContent = 'è¯·å…ˆè¿æ¥é’±åŒ…';
                    return;
                }
                
                if (!AppState.areContractsReady()) {
                    document.getElementById('memberStatus').textContent = 'åˆçº¦æœªåˆå§‹åŒ–';
                    return;
                }
                
                try {
                    UIManager.clearMemberInfo();
                    
                    // æŸ¥è¯¢ç”¨æˆ·æŒæœ‰çš„NFTæ•°é‡
                    const balance = await AppState.contracts.jvcore.methods.balanceOf(AppState.userAccount).call();
                    const isMember = balance > 0;
                    
                    UIManager.updateMemberStatus(isMember, balance);
                    
                    if (isMember) {
                        await this.displayMemberNumbers();
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æˆå‘˜èµ„æ ¼å¤±è´¥:', error);
                    document.getElementById('memberStatus').textContent = 'æ£€æŸ¥å¤±è´¥';
                    UIManager.showStatus('æ£€æŸ¥æˆå‘˜èµ„æ ¼å¤±è´¥: ' + error.message, 'error');
                }
            },
            
            /**
             * æ˜¾ç¤ºæˆå‘˜ç¼–å·å’Œæœ€åç­¾åˆ°æ—¶é—´
             * éå†ç”¨æˆ·æŒæœ‰çš„æ‰€æœ‰NFTå¹¶æ˜¾ç¤ºç›¸å…³ä¿¡æ¯
             */
            async displayMemberNumbers() {
                try {
                    const balance = await AppState.contracts.jvcore.methods.balanceOf(AppState.userAccount).call();
                    const memberNumbers = [];
                    let latestCheckInTime = 0;
                    
                    // éå†ç”¨æˆ·æŒæœ‰çš„æ‰€æœ‰NFT
                    for (let i = 0; i < balance; i++) {
                        const tokenId = await AppState.contracts.jvcore.methods.tokenOfOwnerByIndex(AppState.userAccount, i).call();
                        memberNumbers.push(tokenId);
                        
                        try {
                             // è·å–NFTå…ƒæ•°æ®
                             const tokenURI = await AppState.contracts.jvcore.methods.tokenURI(tokenId).call();
                             const metadata = Utils.parseTokenMetadata(tokenURI);
                            
                            // æŸ¥æ‰¾æœ€æ–°çš„ç­¾åˆ°æ—¶é—´
                            if (metadata && metadata.lastCheckInTime) {
                                const checkInTime = parseInt(metadata.lastCheckInTime);
                                if (checkInTime > latestCheckInTime) {
                                    latestCheckInTime = checkInTime;
                                }
                            }
                        } catch (error) {
                            console.error(`è·å–Token ${tokenId} URIå¤±è´¥:`, error);
                        }
                    }
                    
                    // æ˜¾ç¤ºæˆå‘˜ç¼–å·åˆ—è¡¨
                    document.getElementById('memberNumbersList').textContent = memberNumbers.join(', ');
                    document.getElementById('memberNumbers').style.display = 'block';
                    
                    // æ˜¾ç¤ºæœ€åç­¾åˆ°æ—¶é—´ä¿¡æ¯
                    this.displayLastCheckInTime(latestCheckInTime);
                    
                } catch (error) {
                    console.error('è·å–æˆå‘˜ç¼–å·å¤±è´¥:', error);
                    UIManager.showStatus('è·å–æˆå‘˜ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                }
            },
            
            /**
             * æ˜¾ç¤ºæœ€åç­¾åˆ°æ—¶é—´ä¿¡æ¯
             * @param {number} latestCheckInTime - æœ€æ–°ç­¾åˆ°æ—¶é—´æˆ³
             */
            displayLastCheckInTime(latestCheckInTime) {
                const lastCheckInInfoEl = document.getElementById('lastCheckInInfo');
                const lastCheckInTimeEl = document.getElementById('lastCheckInTime');
                const checkInStatusEl = document.getElementById('checkInStatus');
                
                const checkinBtn = document.getElementById('checkinBtn');
                
                if (latestCheckInTime && latestCheckInTime > 0) {
                    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                    const formattedTime = Utils.formatTimestamp(latestCheckInTime);
                    lastCheckInTimeEl.textContent = formattedTime;
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬æœˆç­¾åˆ°
                    const isThisMonth = Utils.isCurrentMonth(latestCheckInTime);
                    if (isThisMonth) {
                        checkInStatusEl.textContent = 'âœ… æœ¬æœˆå·²ç­¾åˆ°';
                        checkInStatusEl.style.color = '#00ff88';
                        window.hasCheckedInThisMonth = true;
                        // æ˜¾ç¤ºç­¾åˆ°æŒ‰é’®ï¼Œå…è®¸å†æ¬¡ç­¾åˆ°
                        if (checkinBtn) {
                            checkinBtn.classList.remove('hidden');
                            checkinBtn.textContent = 'ğŸ¯ å†æ¬¡ç­¾åˆ°';
                        }
                    } else {
                        checkInStatusEl.textContent = 'âŒ æœ¬æœˆæœªç­¾åˆ°';
                        checkInStatusEl.style.color = '#f44336';
                        window.hasCheckedInThisMonth = false;
                        // æ˜¾ç¤ºç­¾åˆ°æŒ‰é’®
                        if (checkinBtn) {
                            checkinBtn.classList.remove('hidden');
                            checkinBtn.textContent = 'ğŸ¯ ç«‹å³ç­¾åˆ°';
                        }
                    }
                    
                    lastCheckInInfoEl.style.display = 'block';
                } else {
                    // æ²¡æœ‰ç­¾åˆ°è®°å½•
                    lastCheckInTimeEl.textContent = 'æ— è®°å½•';
                    checkInStatusEl.textContent = 'âŒ æœ¬æœˆæœªç­¾åˆ°';
                    checkInStatusEl.style.color = '#f44336';
                    lastCheckInInfoEl.style.display = 'block';
                    window.hasCheckedInThisMonth = false;
                    // æ˜¾ç¤ºç­¾åˆ°æŒ‰é’®
                    if (checkinBtn) {
                        checkinBtn.classList.remove('hidden');
                        checkinBtn.textContent = 'ğŸ¯ ç«‹å³ç­¾åˆ°';
                    }
                }
            }
        };
        
    /**
     * ç­¾åˆ°ç®¡ç†å™¨
     * å¤„ç†ç”¨æˆ·ç­¾åˆ°ç›¸å…³æ“ä½œ
     */
    const CheckInManager = {
            /**
             * æ‰§è¡Œç­¾åˆ°æ“ä½œ
             * è°ƒç”¨æ™ºèƒ½åˆçº¦è¿›è¡Œç­¾åˆ°å¹¶å¤„ç†ç»“æœ
             */
            async performCheckIn() {
                const checkinBtn = document.getElementById('checkinBtn');
                
                // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
                if (!AppState.userAccount) {
                    UIManager.showStatus('è¯·å…ˆè¿æ¥é’±åŒ…ï¼', 'error');
                    return;
                }
                
                // æ£€æŸ¥åˆçº¦åˆå§‹åŒ–çŠ¶æ€
                if (!AppState.areContractsReady()) {
                    UIManager.showStatus('ç­¾åˆ°åˆçº¦æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    return;
                }
                
                // æ£€æŸ¥æœ¬æœˆæ˜¯å¦å·²ç­¾åˆ°
                if (window.hasCheckedInThisMonth) {
                    const confirmReCheckIn = confirm('æ‚¨æœ¬æœˆå·²ç»ç­¾åˆ°è¿‡äº†ï¼Œæ˜¯å¦è¦å†æ¬¡ç­¾åˆ°ï¼Ÿ');
                    if (!confirmReCheckIn) {
                        UIManager.showStatus('å·²å–æ¶ˆç­¾åˆ°', 'info');
                        return;
                    }
                }
                
                try {
                    // æ·»åŠ åŠ è½½çŠ¶æ€
                    checkinBtn.classList.add('loading');
                    checkinBtn.textContent = 'ç­¾åˆ°ä¸­...';
                    checkinBtn.disabled = true;
                    
                    UIManager.showStatus('æ­£åœ¨è·å–NFTä¿¡æ¯...', 'info');
                    
                    // è·å–ç”¨æˆ·æŒæœ‰çš„ç¬¬ä¸€ä¸ªJVCore NFTçš„tokenId
                    let userTokenId;
                    try {
                        const balance = await AppState.contracts.jvcore.methods.balanceOf(AppState.userAccount).call();
                        if (parseInt(balance) === 0) {
                            throw new Error('ç­¾åˆ°å¤±è´¥ï¼šæ‚¨ä¸æ˜¯JVCoreæˆå‘˜ï¼Œè¯·å…ˆè·å–JVCore NFTã€‚');
                        }
                        
                        // è·å–ç”¨æˆ·æŒæœ‰çš„ç¬¬ä¸€ä¸ªNFTçš„tokenId
                        userTokenId = await AppState.contracts.jvcore.methods.tokenOfOwnerByIndex(AppState.userAccount, 0).call();
                        console.log('ç”¨æˆ·NFT tokenId:', userTokenId);
                    } catch (tokenError) {
                        console.error('è·å–NFT tokenIdå¤±è´¥:', tokenError);
                        if (tokenError.message.startsWith('ç­¾åˆ°å¤±è´¥ï¼š')) {
                            throw tokenError;
                        }
                        throw new Error('ç­¾åˆ°å¤±è´¥ï¼šæ— æ³•è·å–NFTä¿¡æ¯ï¼Œè¯·ç¡®ä¿æ‚¨æŒæœ‰JVCore NFTã€‚');
                    }
                    
                    UIManager.showStatus('æ­£åœ¨ç­¾åˆ°...', 'info');
                    
                    // å…ˆä¼°ç®—Gasè´¹ç”¨
                    let gasEstimate;
                    try {
                        gasEstimate = await AppState.contracts.jvcore.methods.checkIn(userTokenId).estimateGas({
                            from: AppState.userAccount
                        });
                        console.log('Gasä¼°ç®—:', gasEstimate);
                    } catch (estimateError) {
                        console.error('Gasä¼°ç®—å¤±è´¥:', estimateError);
                        
                        // å½“Gasä¼°ç®—å¤±è´¥æ—¶ï¼Œæ£€æŸ¥å…·ä½“åŸå› 
                        let errorMessage = 'ç­¾åˆ°å¤±è´¥ï¼š';
                        
                        try {
                            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºJVCoreæˆå‘˜
                            const balance = await AppState.contracts.jvcore.methods.balanceOf(AppState.userAccount).call();
                            if (parseInt(balance) === 0) {
                                errorMessage += 'æ‚¨ä¸æ˜¯JVCoreæˆå‘˜ï¼Œè¯·å…ˆè·å–JVCore NFTã€‚';
                                throw new Error(errorMessage);
                            }
                            
                            // å¦‚æœç”¨æˆ·æ˜¯æˆå‘˜ä½†Gasä¼°ç®—å¤±è´¥ï¼Œå¯èƒ½æ˜¯å·²ç»ç­¾åˆ°æˆ–å…¶ä»–åˆçº¦é™åˆ¶
                            errorMessage += 'Gasä¼°ç®—å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š1) ä»Šæ—¥å·²ç­¾åˆ° 2) ç½‘ç»œå¼‚å¸¸ 3) åˆçº¦æš‚æ—¶ä¸å¯ç”¨ã€‚è¯¦ç»†é”™è¯¯: ' + estimateError.message;
                            
                        } catch (checkError) {
                            // å¦‚æœæ˜¯æˆ‘ä»¬æŠ›å‡ºçš„é”™è¯¯ï¼Œç›´æ¥ä¼ é€’
                            if (checkError.message.startsWith('ç­¾åˆ°å¤±è´¥ï¼š')) {
                                throw checkError;
                            }
                            // å¦‚æœæ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜
                            errorMessage += 'æ— æ³•éªŒè¯ç­¾åˆ°æ¡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚';
                        }
                        
                        // ä½¿ç”¨é»˜è®¤Gaså€¼ä½œä¸ºé™çº§å¤„ç†
                         console.warn('Gasä¼°ç®—å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤Gaså€¼:', errorMessage);
                         gasEstimate = 200000; // é»˜è®¤Gaså€¼
                         UIManager.showStatus('æ­£åœ¨ä½¿ç”¨é»˜è®¤Gasè®¾ç½®é‡è¯•ç­¾åˆ°...', 'info');
                    }
                    
                    // è°ƒç”¨ç­¾åˆ°åˆçº¦æ–¹æ³•ï¼Œä½¿ç”¨ä¼°ç®—çš„Gas + 20%ç¼“å†²
                    const gasLimit = Math.floor(gasEstimate * 1.2);
                    console.log('ä½¿ç”¨Gasé™åˆ¶:', gasLimit);
                    
                    const result = await AppState.contracts.jvcore.methods.checkIn(userTokenId).send({
                        from: AppState.userAccount,
                        gas: gasLimit
                    });
                    
                    UIManager.showStatus('ç­¾åˆ°æˆåŠŸï¼ğŸ‰', 'success');
                    console.log('ç­¾åˆ°äº¤æ˜“:', result);
                    
                    // ç­¾åˆ°æˆåŠŸåŠ¨ç”»æ•ˆæœ
                    checkinBtn.style.animation = 'pulse 0.5s ease-in-out';
                    
                    // ç­¾åˆ°æˆåŠŸåå»¶è¿Ÿåˆ·æ–°æˆå‘˜ä¿¡æ¯
                    setTimeout(() => {
                        MemberManager.checkMembership();
                    }, 2000);
                    
                } catch (error) {
                    console.error('ç­¾åˆ°å¤±è´¥:', error);
                    
                    // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
                    if (error.message.includes('User denied')) {
                        UIManager.showStatus('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error');
                    } else if (error.message.startsWith('ç­¾åˆ°å¤±è´¥ï¼š')) {
                        // è¿™æ˜¯æˆ‘ä»¬åœ¨Gasä¼°ç®—é˜¶æ®µæŠ›å‡ºçš„è¯¦ç»†é”™è¯¯
                        UIManager.showStatus(error.message, 'error');
                    } else if (error.message.includes('reverted')) {
                        // äº¤æ˜“è¢«å›æ»šçš„è¯¦ç»†é”™è¯¯å¤„ç†
                        console.error('äº¤æ˜“å›æ»šè¯¦æƒ…:', {
                            message: error.message,
                            receipt: error.receipt,
                            reason: error.reason
                        });
                        
                        let errorMsg = 'ç­¾åˆ°å¤±è´¥ï¼šäº¤æ˜“è¢«åŒºå—é“¾ç½‘ç»œæ‹’ç»ã€‚';
                        
                        // æ£€æŸ¥å¸¸è§çš„å›æ»šåŸå› 
                        if (error.message.includes('insufficient funds')) {
                            errorMsg += ' åŸå› ï¼šä½™é¢ä¸è¶³ï¼Œè¯·ç¡®ä¿è´¦æˆ·æœ‰è¶³å¤Ÿçš„Jä»£å¸æ”¯ä»˜Gasè´¹ç”¨ã€‚ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šè¯·å‘è´¦æˆ·å……å€¼Jä»£å¸ã€‚';
                        } else if (error.message.includes('Check-in too soon')) {
                            errorMsg = 'ç­¾åˆ°å¤±è´¥ï¼šè·ç¦»ä¸Šæ¬¡ç­¾åˆ°æ—¶é—´ä¸è¶³24å°æ—¶ï¼Œè¯·ç­‰å¾…è¶³å¤Ÿæ—¶é—´åå†æ¬¡ç­¾åˆ°ã€‚ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ¯æ¬¡ç­¾åˆ°é—´éš”éœ€è¦å¤§äº86400ç§’ï¼ˆ24å°æ—¶ï¼‰ã€‚';
                        } else if (error.message.includes('already checked in')) {
                            errorMsg += ' åŸå› ï¼šä»Šæ—¥å·²ç­¾åˆ°ï¼Œè¯·æ˜å¤©å†æ¥ã€‚ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ¯æ—¥åªèƒ½ç­¾åˆ°ä¸€æ¬¡ï¼Œè¯·ç­‰å¾…æ˜å¤©ã€‚';
                        } else if (error.message.includes('not a member')) {
                            errorMsg += ' åŸå› ï¼šæ‚¨ä¸æ˜¯JVCoreæˆå‘˜ï¼Œè¯·å…ˆè·å–JVCore NFTã€‚ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šè¯·è®¿é—®å®˜æ–¹æ¸ é“è·å–JVCore NFTã€‚';
                        } else {
                            errorMsg += ' ğŸ’¡ è¯·æ£€æŸ¥ï¼š1) ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ 2) æ˜¯å¦ä¸ºJVCoreæˆå‘˜ 3) è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³ 4) ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°';
                        }
                        
                        UIManager.showStatus(errorMsg, 'error');
                    } else if (error.message.includes('network')) {
                        UIManager.showStatus('ç½‘ç»œé”™è¯¯ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ‡æ¢åˆ°JNS DAOç½‘ç»œã€‚ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šè¯·ç¡®ä¿è¿æ¥åˆ°æ­£ç¡®çš„ç½‘ç»œã€‚', 'error');
                    } else if (error.code === 32000) {
                        UIManager.showStatus('ç­¾åˆ°æ¡ä»¶ä¸æ»¡è¶³ï¼šè¯·ç¡®ä¿æ‚¨æ˜¯JVCoreæˆå‘˜ä¸”ä»Šæ—¥æœªç­¾åˆ°ã€‚ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æˆå‘˜çŠ¶æ€å’Œç­¾åˆ°è®°å½•ã€‚', 'error');
                    } else {
                        UIManager.showStatus('ç­¾åˆ°å¤±è´¥: ' + error.message + ' ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šè¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚', 'error');
                    }
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    checkinBtn.classList.remove('loading');
                    // æ ¹æ®ç­¾åˆ°çŠ¶æ€æ¢å¤æ­£ç¡®çš„æŒ‰é’®æ–‡æ¡ˆ
                    if (window.hasCheckedInThisMonth) {
                        checkinBtn.textContent = 'ğŸ¯ å†æ¬¡ç­¾åˆ°';
                    } else {
                        checkinBtn.textContent = 'ğŸ¯ ç«‹å³ç­¾åˆ°';
                    }
                    checkinBtn.disabled = false;
                    
                    // é‡ç½®åŠ¨ç”»
                    setTimeout(() => {
                        checkinBtn.style.animation = '';
                    }, 500);
                }
            }
        };

        

        

        
        /**
         * ç›‘å¬MetaMaskäº‹ä»¶
         * å¤„ç†è´¦æˆ·åˆ‡æ¢å’Œç½‘ç»œå˜åŒ–
         */
        if (typeof window.ethereum !== 'undefined') {
            // ç›‘å¬è´¦æˆ·å˜åŒ–äº‹ä»¶
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // ç”¨æˆ·æ–­å¼€äº†æ‰€æœ‰è´¦æˆ·
                    disconnectWallet();
                } else if (accounts[0] !== AppState.userAccount) {
                    // ç”¨æˆ·åˆ‡æ¢äº†è´¦æˆ·
                    AppState.userAccount = accounts[0];
                    document.getElementById('walletAddress').textContent = `é’±åŒ…åœ°å€: ${AppState.userAccount}`;
                    
                    // æ¸…é™¤æ—§è´¦æˆ·çš„çŠ¶æ€ä¿¡æ¯
                    UIManager.clearMemberInfo();
                    
                    // é‡æ–°æ£€æŸ¥æ–°è´¦æˆ·çš„æˆå‘˜çŠ¶æ€
                    MemberManager.checkMembership();
                }
            });
            
            // ç›‘å¬ç½‘ç»œå˜åŒ–äº‹ä»¶
            let chainChangeTimeout;
            window.ethereum.on('chainChanged', function (chainId) {
                console.log('ç½‘ç»œå˜åŒ–æ£€æµ‹åˆ°:', chainId);
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢é¢‘ç¹è§¦å‘
                if (chainChangeTimeout) {
                    clearTimeout(chainChangeTimeout);
                }
                
                // æ·»åŠ é˜²æŠ–æœºåˆ¶ï¼Œå»¶è¿Ÿå¤„ç†ç½‘ç»œå˜åŒ–
                chainChangeTimeout = setTimeout(async () => {
                    try {
                        // æ£€æŸ¥æ˜¯å¦åœ¨æ¬§æ˜“å®¢æˆ·ç«¯ä¸­
                        const isOKXApp = /OKApp/i.test(navigator.userAgent) || window.okxwallet;
                        
                        if (isOKXApp) {
                            // åœ¨æ¬§æ˜“å®¢æˆ·ç«¯ä¸­ï¼Œä¸é‡æ–°åŠ è½½é¡µé¢ï¼Œè€Œæ˜¯é‡æ–°åˆå§‹åŒ–åˆçº¦
                            console.log('æ£€æµ‹åˆ°æ¬§æ˜“å®¢æˆ·ç«¯ï¼Œé‡æ–°åˆå§‹åŒ–åˆçº¦è€Œéé‡è½½é¡µé¢');
                            UIManager.showStatus('ç½‘ç»œå·²åˆ‡æ¢ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...', 'info');
                            
                            // æ¸…é™¤å½“å‰çŠ¶æ€
                            AppState.contracts = {};
                            UIManager.clearMemberInfo();
                            
                            // é‡æ–°åˆå§‹åŒ–åˆçº¦
                            if (AppState.userAccount) {
                                await ContractManager.initialize();
                                await MemberManager.checkMembership();
                                UIManager.showStatus('ç½‘ç»œåˆ‡æ¢å®Œæˆ', 'success');
                            }
                        } else {
                            // åœ¨å…¶ä»–ç¯å¢ƒä¸­ï¼Œæ£€æŸ¥ç½‘ç»œæ˜¯å¦æ­£ç¡®
                            const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                            const targetChainId = CONFIG.network.chainId; // ä½¿ç”¨é…ç½®ä¸­çš„é“¾ID
                            
                            if (currentChainId !== targetChainId) {
                                // åªæœ‰åœ¨ç½‘ç»œä¸åŒ¹é…æ—¶æ‰æç¤ºåˆ‡æ¢
                                UIManager.showStatus('è¯·åˆ‡æ¢åˆ°JNS DAOç½‘ç»œ', 'error');
                            } else {
                                // ç½‘ç»œæ­£ç¡®ï¼Œé‡æ–°åˆå§‹åŒ–åˆçº¦
                                if (AppState.userAccount) {
                                    await ContractManager.initialize();
                                    await MemberManager.checkMembership();
                                }
                            }
                        }
                    } catch (error) {
                        console.error('å¤„ç†ç½‘ç»œå˜åŒ–å¤±è´¥:', error);
                        UIManager.showStatus('ç½‘ç»œåˆ‡æ¢å¤„ç†å¤±è´¥: ' + error.message, 'error');
                    }
                }, 1000); // 1ç§’é˜²æŠ–å»¶è¿Ÿ
            });
        }
        

        
        // é¡µé¢åˆå§‹åŒ–ä»£ç å·²ç§»åŠ¨åˆ° initializeMainApp å‡½æ•°ä¸­
        
        
        function initializeMainApp() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥é’±åŒ…ï¼Œå¦‚æœæ˜¯åˆ™è‡ªåŠ¨è¿æ¥
            window.addEventListener('load', async function() {
                // åˆ›å»ºèƒŒæ™¯ç²’å­æ•ˆæœ
                createParticles();
                
                // åˆ›å»ºæ•°æ®æµæ•ˆæœ
                createDataStreams();
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥é’±åŒ…ï¼Œå¦‚æœæ˜¯åˆ™è‡ªåŠ¨è¿æ¥
                if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                    await connectWallet();
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åº”ç”¨
        initializeMainApp();
    </script>
</body>
</html>